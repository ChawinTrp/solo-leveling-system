<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solo Leveling System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .progress-bar-container { background-color: #374151; }
        .progress-bar { background-color: #3b82f6; transition: width 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 sm:p-6 md:p-8">

    <script src="wasm_exec.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE ---
        const firebaseConfig = {
            apiKey: "...",
            authDomain: "...",
            projectId: "...",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "..."
        };

        // --- GLOBAL VARIABLES ---
        let db, auth, userId;

        // --- CORE LOGIC ---
        async function main() {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Listen for authentication state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in anonymously.
                    userId = user.uid;
                    console.log("User signed in with UID:", userId);
                    await initWasm();
                } else {
                    // User is signed out.
                    console.log("User is not signed in. Signing in anonymously...");
                    signInAnonymously(auth).catch((error) => {
                        console.error("Anonymous sign-in failed:", error);
                        document.getElementById('loading-screen').innerHTML = '<p class="text-red-500 text-lg">Authentication Failed. Cannot save data.</p>';
                    });
                }
            });
        }

        // --- WASM INITIALIZATION ---
        async function initWasm() {
            const go = new Go();
            try {
                const result = await WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject);
                go.run(result.instance);
            } catch (error) {
                console.error("Error loading WASM:", error);
                document.getElementById('loading-screen').innerHTML = '<p class="text-red-500 text-lg">Failed to load system. Check console.</p>';
                return;
            }

            // Load saved data from FIRESTORE or get initial state
            const docRef = doc(db, "users", userId);
            const docSnap = await getDoc(docRef);

            let initialPlayerData;
            if (docSnap.exists()) {
                console.log("Found Firestore data. Loading...");
                // Pass the saved JSON data to our Go function
                initialPlayerData = JSON.parse(loadPlayerData(JSON.stringify(docSnap.data())));
            } else {
                console.log("No Firestore data found. Initializing new player.");
                // Get the default state from our Go function
                initialPlayerData = JSON.parse(getPlayerData());
            }
            
            updateUI(initialPlayerData);
            
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('app-content').classList.remove('opacity-0');
        }

        // --- UI & DATA FUNCTIONS ---
        window.updateUI = function(playerData) {
             if (!playerData) return;
            document.getElementById('player-level').textContent = playerData.level;
            document.getElementById('player-xp-text').textContent = `${playerData.xp} / ${playerData.xpToNextLevel}`;
            document.getElementById('player-xp-bar').style.width = `${Math.min((playerData.xp / playerData.xpToNextLevel) * 100, 100)}%`;
            document.getElementById('player-strength').textContent = playerData.strength;
            document.getElementById('player-intelligence').textContent = playerData.intelligence;
            document.getElementById('player-dexterity').textContent = playerData.dexterity;

            const habitsList = document.getElementById('habits-list');
            habitsList.innerHTML = '';
            if (playerData.habits && playerData.habits.length > 0) {
                 playerData.habits.forEach((habit, index) => {
                    const habitElement = document.createElement('div');
                    habitElement.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center shadow';
                    habitElement.innerHTML = `
                        <div>
                            <p class="font-medium">${habit.name}</p>
                            <p class="text-sm text-green-400">+${habit.xpValue} XP</p>
                        </div>
                        <button data-index="${index}" class="complete-btn bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-1.5 rounded-lg transition-colors flex-shrink-0 ml-2">Complete</button>
                    `;
                    habitsList.appendChild(habitElement);
                });
            } else {
                 habitsList.innerHTML = '<p class="text-gray-500 text-center py-4">No active habits. Add one to begin your journey!</p>';
            }
            
            // Save the new state to FIRESTORE
            saveStateToFirestore(playerData);
        }
        
        async function saveStateToFirestore(playerData) {
            if (!userId) {
                console.error("Cannot save state: No user ID.");
                return;
            }
            try {
                // We save the entire player object to a document named after the user's ID
                await setDoc(doc(db, "users", userId), playerData);
            } catch (e) {
                console.error("Error saving to Firestore: ", e);
            }
        }

        // --- EVENT LISTENERS ---
        document.getElementById('add-habit-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('habit-input');
            const habitName = input.value.trim();
            if (habitName) {
                const updatedPlayerData = JSON.parse(addHabit(habitName));
                window.updateUI(updatedPlayerData);
                input.value = '';
            }
        });

        document.getElementById('habits-list').addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('complete-btn')) {
                const index = parseInt(e.target.getAttribute('data-index'), 10);
                const updatedPlayerData = JSON.parse(completeHabit(index));
                window.updateUI(updatedPlayerData);
            }
        });

        // Start the application
        main();
    </script>
    
    <!-- App Content (No changes needed below) -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50">
        <svg class="animate-spin h-10 w-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <p class="mt-4 text-lg">Authenticating & Loading System...</p>
    </div>
    <div id="app-content" class="max-w-4xl mx-auto opacity-0 transition-opacity duration-500">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-400 tracking-wider">Solo Leveling System</h1>
            <p class="text-gray-400 mt-2">Complete your habits, gain XP, and level up your life.</p>
        </header>
        <section class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Player Status</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="bg-gray-700 p-4 rounded-lg text-center"><p class="text-sm text-gray-400">LEVEL</p><p id="player-level" class="text-2xl font-bold">1</p></div>
                <div class="flex-grow bg-gray-700 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-1"><p class="text-sm text-gray-400">EXPERIENCE</p><p id="player-xp-text" class="text-sm font-medium">0 / 100</p></div>
                    <div class="w-full progress-bar-container rounded-full h-4"><div id="player-xp-bar" class="progress-bar h-4 rounded-full" style="width: 0%"></div></div>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4 mt-4">
                <div class="bg-gray-700 p-4 rounded-lg text-center"><p class="text-sm text-gray-400">STRENGTH</p><p id="player-strength" class="text-2xl font-bold">1</p></div>
                <div class="bg-gray-700 p-4 rounded-lg text-center"><p class="text-sm text-gray-400">INTELLIGENCE</p><p id="player-intelligence" class="text-2xl font-bold">1</p></div>
                <div class="bg-gray-700 p-4 rounded-lg text-center"><p class="text-sm text-gray-400">DEXTERITY</p><p id="player-dexterity" class="text-2xl font-bold">1</p></div>
            </div>
        </section>
        <section>
            <h2 class="text-2xl font-semibold mb-4">Habit Quest Log</h2>
            <form id="add-habit-form" class="flex flex-col sm:flex-row gap-2 mb-4">
                <input type="text" id="habit-input" placeholder="Enter a new habit..." class="w-full flex-grow bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                <button type="submit" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg transition-colors">Add</button>
            </form>
            <div id="habits-list" class="space-y-3"></div>
        </section>
    </div>
</body>
</html>

